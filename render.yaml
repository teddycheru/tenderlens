services:
  # Backend API Web Service
  - type: web
    name: tenderlens-backend
    env: docker
    region: oregon
    plan: free
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    healthCheckPath: /health
    envVars:
      - key: POSTGRES_USER
        sync: false
      - key: POSTGRES_PASSWORD
        sync: false
      - key: POSTGRES_DB
        sync: false
      - key: POSTGRES_HOST
        sync: false
      - key: POSTGRES_PORT
        sync: false
      - key: REDIS_URL
        sync: false
      - key: SECRET_KEY
        generateValue: true
      - key: AI_OPENAI_API_KEY
        sync: false
      - key: AI_OPENAI_MODEL
        value: gpt-4
      - key: AI_ENABLED
        value: true
      - key: EMBEDDING_PROVIDER
        value: local
      - key: EMBEDDING_MODEL
        value: sentence-transformers/all-MiniLM-L6-v2
      - key: ALGORITHM
        value: HS256
      - key: ACCESS_TOKEN_EXPIRE_MINUTES
        value: 30
      - key: REFRESH_TOKEN_EXPIRE_DAYS
        value: 7
      - key: PROJECT_NAME
        value: TenderLens API
      - key: VERSION
        value: 0.1.0
      - key: API_V1_STR
        value: /api/v1
      - key: BACKEND_CORS_ORIGINS
        value: '["https://tenderlens.vercel.app","https://tenderlens-n7zr40jor-tewodros-cherus-projects.vercel.app","http://localhost:3000","http://localhost:5173"]'
      - key: CELERY_BROKER_URL
        sync: false
      - key: CELERY_RESULT_BACKEND
        sync: false
      - key: AI_OPENAI_MAX_TOKENS
        value: 500
      - key: AI_OPENAI_TEMPERATURE
        value: 0.3
      - key: AI_SUMMARY_MAX_LENGTH
        value: 150
      - key: AI_QUICK_SCAN_MAX_LENGTH
        value: 25
      - key: AI_SPACY_MODEL
        value: en_core_web_sm
      - key: AI_CACHE_TTL
        value: 86400
      - key: AI_TIMEOUT
        value: 30
      - key: HF_TOKEN
        sync: false
      - key: HF_HOME
        value: /root/.cache/huggingface
      - key: HUGGINGFACE_HUB_CACHE
        value: /root/.cache/huggingface/hub
      - key: HF_DATASETS_OFFLINE
        value: 1
      - key: TRANSFORMERS_OFFLINE
        value: 0

  # Celery Worker as Web Service (Free tier)
  - type: web
    name: tenderlens-celery-worker
    env: docker
    region: oregon
    plan: free
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    dockerCommand: celery -A app.workers.celery_app worker --loglevel=info --concurrency=2 -Q celery,ai_processing,batch_processing,embeddings,batch_embeddings,maintenance
    envVars:
      - key: POSTGRES_USER
        sync: false
      - key: POSTGRES_PASSWORD
        sync: false
      - key: POSTGRES_DB
        sync: false
      - key: POSTGRES_HOST
        sync: false
      - key: POSTGRES_PORT
        sync: false
      - key: REDIS_URL
        sync: false
      - key: AI_OPENAI_API_KEY
        sync: false
      - key: AI_ENABLED
        value: true
      - key: EMBEDDING_PROVIDER
        value: local
      - key: EMBEDDING_MODEL
        value: sentence-transformers/all-MiniLM-L6-v2
      - key: ALGORITHM
        value: HS256
      - key: API_V1_STR
        value: /api/v1
      - key: CELERY_BROKER_URL
        sync: false
      - key: CELERY_RESULT_BACKEND
        sync: false
      - key: AI_OPENAI_MAX_TOKENS
        value: 500
      - key: AI_OPENAI_TEMPERATURE
        value: 0.3
      - key: AI_OPENAI_MODEL
        value: gpt-4-turbo-preview
      - key: AI_SUMMARY_MAX_LENGTH
        value: 150
      - key: AI_QUICK_SCAN_MAX_LENGTH
        value: 25
      - key: AI_SPACY_MODEL
        value: en_core_web_sm
      - key: AI_CACHE_TTL
        value: 86400
      - key: AI_TIMEOUT
        value: 30
      - key: HF_TOKEN
        sync: false
      - key: HF_HOME
        value: /root/.cache/huggingface
      - key: HUGGINGFACE_HUB_CACHE
        value: /root/.cache/huggingface/hub
      - key: HF_DATASETS_OFFLINE
        value: 1
      - key: TRANSFORMERS_OFFLINE
        value: 0

  # Flower Monitoring (Optional - Private Service)
  - type: web
    name: tenderlens-flower
    env: docker
    region: oregon
    plan: free
    dockerfilePath: ./backend/Dockerfile
    dockerContext: ./backend
    dockerCommand: celery -A app.workers.celery_app flower --port=$PORT
    envVars:
      - key: REDIS_URL
        sync: false
      - key: CELERY_BROKER_URL
        sync: false
      - key: CELERY_RESULT_BACKEND
        sync: false
